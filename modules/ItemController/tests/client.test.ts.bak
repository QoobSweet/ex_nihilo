import { ItemControllerClient } from '../src/client.js';

/**
 * Integration tests for ItemController Client
 *
 * Prerequisites:
 * - ItemController server must be running on port 3034
 * - Database must be setup (npm run db:setup)
 *
 * Run with: npm test
 */

describe('ItemController Client Integration Tests', () => {
  let client: ItemControllerClient;
  let testTemplateId: number;
  let testItemId: number;
  const testCharacterId = 'test_character_' + Date.now();

  beforeAll(() => {
    client = new ItemControllerClient('http://localhost:3034');
  });

  describe('Health Check', () => {
    it('should return healthy status', async () => {
      const health = await client.healthCheck();
      expect(health.status).toBe('healthy');
      expect(health.service).toBe('ItemController');
    });
  });

  describe('Template Management', () => {
    it('should create an item template', async () => {
      const template = await client.createTemplate({
        name: 'Test Sword ' + Date.now(),
        description: 'A test sword for integration testing',
        item_type: 'weapon',
        rarity: 'common',
        weight: 5,
        base_value: 100,
        is_stackable: false,
        max_stack_size: 1,
        damage_dice: '1d8',
        is_magical: false,
        requires_attunement: false,
        is_consumable: false,
      });

      expect(template).toBeDefined();
      expect(template.id).toBeDefined();
      expect(template.name).toContain('Test Sword');
      testTemplateId = template.id!;
    });

    it('should get template by id', async () => {
      const template = await client.getTemplate(testTemplateId);
      expect(template).toBeDefined();
      expect(template?.id).toBe(testTemplateId);
    });

    it('should search templates', async () => {
      const result = await client.searchTemplates({
        item_type: 'weapon',
        limit: 10,
      });

      expect(result.templates).toBeDefined();
      expect(Array.isArray(result.templates)).toBe(true);
      expect(result.total).toBeGreaterThanOrEqual(1);
    });
  });

  describe('Item Instance Management', () => {
    it('should create an item and give to character', async () => {
      const item = await client.giveItemToCharacter(testTemplateId, testCharacterId, 1);

      expect(item).toBeDefined();
      expect(item.id).toBeDefined();
      expect(item.current_owner_type).toBe('character');
      expect(item.current_owner_id).toBe(testCharacterId);
      expect(item.template.id).toBe(testTemplateId);
      testItemId = item.id!;
    });

    it('should get item by id', async () => {
      const item = await client.getItem(testItemId);
      expect(item).toBeDefined();
      expect(item?.id).toBe(testItemId);
    });

    it('should equip item', async () => {
      const item = await client.equipItem(testItemId, testCharacterId);
      expect(item.is_equipped).toBe(true);
    });

    it('should unequip item', async () => {
      const item = await client.unequipItem(testItemId, testCharacterId);
      expect(item.is_equipped).toBe(false);
    });
  });

  describe('Inventory Management', () => {
    it('should get character inventory', async () => {
      const inventory = await client.getInventory(testCharacterId);

      expect(inventory).toBeDefined();
      expect(inventory.items).toBeDefined();
      expect(Array.isArray(inventory.items)).toBe(true);
      expect(inventory.totalWeight).toBeGreaterThanOrEqual(0);
      expect(inventory.totalValue).toBeGreaterThanOrEqual(0);
      expect(inventory.items.length).toBeGreaterThanOrEqual(1);
    });

    it('should calculate character wealth', async () => {
      const wealth = await client.getCharacterWealth(testCharacterId);
      expect(wealth).toBeGreaterThanOrEqual(100); // At least our test sword value
    });

    it('should check if character can carry more', async () => {
      const canCarry = await client.canCarry(testCharacterId, 10, 100);
      expect(typeof canCarry).toBe('boolean');
    });
  });

  describe('Item Movement', () => {
    it('should drop item in world', async () => {
      const item = await client.dropItem(testItemId, {
        character_id: testCharacterId,
        x: 100,
        y: 200,
      });

      expect(item.current_owner_type).toBe('world');
      expect(item.x_coord).toBe(100);
      expect(item.y_coord).toBe(200);
      expect(item.is_equipped).toBe(false);
    });

    it('should find nearby items', async () => {
      const items = await client.getItemsNearby(100, 200, 50);
      expect(Array.isArray(items)).toBe(true);
      expect(items.length).toBeGreaterThanOrEqual(1);
    });

    it('should pickup item from world', async () => {
      const item = await client.pickupItem(testItemId, {
        character_id: testCharacterId,
      });

      expect(item.current_owner_type).toBe('character');
      expect(item.current_owner_id).toBe(testCharacterId);
    });

    it('should get item history', async () => {
      const history = await client.getItemHistory(testItemId);
      expect(Array.isArray(history)).toBe(true);
      expect(history.length).toBeGreaterThanOrEqual(3); // spawn, drop, pickup
    });
  });

  describe('Item Trading', () => {
    const secondCharacterId = 'test_character_2_' + Date.now();

    it('should transfer item between characters', async () => {
      const item = await client.transferItem(testItemId, testCharacterId, secondCharacterId);

      expect(item.current_owner_id).toBe(secondCharacterId);
    });

    it('should show item in new owner inventory', async () => {
      const inventory = await client.getInventory(secondCharacterId);
      expect(inventory.items.length).toBeGreaterThanOrEqual(1);
      const hasItem = inventory.items.some((item) => item.id === testItemId);
      expect(hasItem).toBe(true);
    });
  });

  describe('Statistics', () => {
    it('should get system statistics', async () => {
      const stats = await client.getStats();

      expect(stats).toBeDefined();
      expect(stats.totalTemplates).toBeGreaterThanOrEqual(1);
      expect(stats.totalItems).toBeGreaterThanOrEqual(1);
      expect(stats.itemsByOwnerType).toBeDefined();
    });
  });

  describe('Cleanup', () => {
    it('should destroy test item', async () => {
      await client.destroyItem(testItemId);
      const item = await client.getItem(testItemId);
      expect(item).toBeNull();
    });
  });
});
